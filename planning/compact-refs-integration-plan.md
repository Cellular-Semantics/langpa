# Compact References Integration Plan for Langpa

## Goal
Extend langpa to include compact reference strings (generated by url2ref) in the bibliography output container, alongside the existing CSL-JSON citations.

## Current State

### url2ref Capabilities
- **Function**: `render_bibliography_to_strings(resolution_result, style="vancouver", locale="en-US")`
- **Location**: `url2ref/src/lit_agent/identifiers/api.py:578-631`
- **Input**: `CitationResolutionResult` object
- **Output**: `tuple[List[str], Dict[str, Any]]`
  - List of formatted citation strings
  - Metadata dict with renderer info (citeproc-py or fallback)
- **Format**: `[id] author_surname [et al.] title year identifier`
- **Example**: `[1] Doe et al. Example Paper 2024 10.1234/example`

### langpa Current Output
The container JSON (`deepsearch_container.json`) contains:
```json
{
  "metadata": {...},
  "deepsearch_raw": {...},
  "report": {...},
  "citations": {
    "1": {"id": "1", "title": "...", "URL": "...", "DOI": "...", ...},
    "2": {...}
  },
  "bibliography_stats": {...},
  "unresolved": [...]
}
```

**Missing**: Compact reference strings for human-readable display

## Proposed Changes

### 1. Enhanced Container JSON Schema

Add a new `compact_bibliography` field to the container JSON:

```json
{
  "metadata": {...},
  "deepsearch_raw": {...},
  "report": {...},
  "citations": {
    "1": {"id": "1", "title": "...", ...},
    "2": {...}
  },
  "compact_bibliography": {
    "entries": [
      "[1] Doe et al. Example Paper 2024 10.1234/example",
      "[2] Smith Nature Study 2023 37674083"
    ],
    "style": "vancouver",
    "locale": "en-US",
    "renderer": "citeproc-py"  // or "fallback"
  },
  "bibliography_stats": {...},
  "unresolved": [...]
}
```

### 2. Implementation Steps

#### Step 1: Import url2ref Rendering Function
**File**: `langpa/src/langpa/services/citation_resolver.py`

Add import:
```python
from lit_agent.identifiers.api import (
    CitationResolutionResult,
    resolve_bibliography,
    render_bibliography_to_strings,  # NEW
)
```

#### Step 2: Extend CitationResolver
**File**: `langpa/src/langpa/services/citation_resolver.py`

Add new method to `CitationResolver` class:
```python
def resolve_citations_with_compact(
    self,
    citations: list[dict[str, str]],
    style: str = "vancouver",
    locale: str = "en-US",
) -> dict[str, Any]:
    """
    Resolve citations and generate compact bibliography strings.

    Args:
        citations: List of {source_id, source_url} dicts
        style: Citation style (default: vancouver)
        locale: Locale for formatting (default: en-US)

    Returns:
        Dict with keys:
        - citations: CSL-JSON citations dict
        - compact_bibliography: Rendered strings and metadata
        - stats: Resolution statistics
        - failures: List of unresolved citations
    """
    # Resolve citations (existing logic)
    resolved = self.resolve_citations(citations)

    # Generate compact strings
    compact_strings, compact_meta = render_bibliography_to_strings(
        resolved["resolution_result"],
        style=style,
        locale=locale,
    )

    return {
        "citations": resolved["citations"],
        "compact_bibliography": {
            "entries": compact_strings,
            "style": style,
            "locale": locale,
            "renderer": compact_meta.get("renderer"),
            "error": compact_meta.get("error"),  # If fallback was used
        },
        "stats": resolved["stats"],
        "failures": resolved["failures"],
    }
```

#### Step 3: Update OutputManager
**File**: `langpa/src/langpa/services/output_manager.py`

Modify `process_and_save_structured_output()` to use the new method:

```python
def process_and_save_structured_output(
    self,
    result: DeepSearchResult,
    schema_path: Path,
    citation_resolver: Optional[CitationResolver] = None,
    citation_style: str = "vancouver",  # NEW parameter
    citation_locale: str = "en-US",      # NEW parameter
) -> dict[str, Any]:
    # ... existing extraction and normalization logic ...

    # Resolve citations with compact refs
    if citation_resolver and normalized_citations:
        resolved = citation_resolver.resolve_citations_with_compact(
            normalized_citations,
            style=citation_style,
            locale=citation_locale,
        )
        citation_map = resolved["citations"]
        compact_bibliography = resolved["compact_bibliography"]
        citation_stats = resolved["stats"]
        unresolved_citations = resolved["failures"]
    else:
        citation_map = {}
        compact_bibliography = None
        citation_stats = {}
        unresolved_citations = []

    # Build container
    container = {
        "metadata": {...},
        "deepsearch_raw": {...},
        "report": structured_output,
        "citations": citation_map,
        "bibliography_stats": {
            "total": len(normalized_citations),
            "resolved": len(citation_map),
            "unresolved": len(unresolved_citations),
            **citation_stats,
        },
        "unresolved": unresolved_citations,
    }

    # Add compact bibliography if available
    if compact_bibliography:
        container["compact_bibliography"] = compact_bibliography

    # Save container
    # ... existing save logic ...
```

#### Step 4: Update CLI Interface
**File**: `langpa/scripts/run_deepsearch.py`

Add new CLI options:
```python
@click.option(
    "--citation-style",
    default="vancouver",
    help="Citation style for compact bibliography (default: vancouver)",
)
@click.option(
    "--citation-locale",
    default="en-US",
    help="Locale for citation formatting (default: en-US)",
)
def main(
    # ... existing params ...
    citation_style: str,
    citation_locale: str,
):
    # ... existing logic ...

    output_manager.process_and_save_structured_output(
        result=result,
        schema_path=schema_path,
        citation_resolver=citation_resolver if resolve_citations else None,
        citation_style=citation_style,
        citation_locale=citation_locale,
    )
```

### 3. Testing Strategy

#### Unit Tests
**File**: `langpa/tests/unit/test_citation_resolver.py`

```python
@pytest.mark.unit
def test_resolve_citations_with_compact():
    """Test that compact bibliography is generated alongside CSL-JSON."""
    resolver = CitationResolver()
    citations = [
        {"source_id": "1", "source_url": "https://pubmed.ncbi.nlm.nih.gov/37674083/"}
    ]

    result = resolver.resolve_citations_with_compact(citations)

    # Check structure
    assert "citations" in result
    assert "compact_bibliography" in result
    assert "stats" in result
    assert "failures" in result

    # Check compact bibliography
    compact = result["compact_bibliography"]
    assert "entries" in compact
    assert isinstance(compact["entries"], list)
    assert "style" in compact
    assert compact["style"] == "vancouver"
    assert "renderer" in compact

    # Check entries format
    if compact["entries"]:
        entry = compact["entries"][0]
        assert entry.startswith("[1]")  # Should have citation ID
```

**File**: `langpa/tests/unit/test_output_manager.py`

```python
@pytest.mark.unit
def test_container_includes_compact_bibliography(tmp_path, mock_resolver):
    """Test that container JSON includes compact bibliography."""
    output_manager = OutputManager(output_dir=tmp_path)

    # Mock result with citations
    result = DeepSearchResult(
        markdown="Test\n\n[1] https://example.com",
        citations=[{"source_id": "1", "source_url": "https://example.com"}],
        duration_seconds=1.0,
    )

    # Mock resolver to return compact bibliography
    mock_resolver.resolve_citations_with_compact.return_value = {
        "citations": {
            "1": {"id": "1", "title": "Test", "URL": "https://example.com"}
        },
        "compact_bibliography": {
            "entries": ["[1] Author Test 2024 https://example.com"],
            "style": "vancouver",
            "locale": "en-US",
            "renderer": "fallback",
        },
        "stats": {},
        "failures": [],
    }

    container = output_manager.process_and_save_structured_output(
        result,
        schema_path=Path("schema.json"),
        citation_resolver=mock_resolver,
    )

    # Verify compact bibliography in container
    assert "compact_bibliography" in container
    assert container["compact_bibliography"]["entries"][0].startswith("[1]")
    assert container["compact_bibliography"]["style"] == "vancouver"
    assert container["compact_bibliography"]["renderer"] == "fallback"
```

#### Integration Tests
**File**: `langpa/tests/integration/test_citation_pipeline.py`

```python
@pytest.mark.integration
def test_end_to_end_with_compact_refs(tmp_path):
    """Test full pipeline from DeepSearch to container with compact refs."""
    # Setup with real resolver (or recorded cassette)
    output_manager = OutputManager(output_dir=tmp_path)
    resolver = CitationResolver()

    result = DeepSearchResult(
        markdown="Research summary\n\n[1] https://pubmed.ncbi.nlm.nih.gov/37674083/",
        citations=[{"source_id": "1", "source_url": "https://pubmed.ncbi.nlm.nih.gov/37674083/"}],
        duration_seconds=1.0,
    )

    container = output_manager.process_and_save_structured_output(
        result,
        schema_path=Path("schema.json"),
        citation_resolver=resolver,
        citation_style="vancouver",
    )

    # Verify compact bibliography exists and is properly formatted
    assert "compact_bibliography" in container
    entries = container["compact_bibliography"]["entries"]
    assert len(entries) == 1
    assert entries[0].startswith("[1]")
    assert "37674083" in entries[0] or "PMC" in entries[0] or "10." in entries[0]
```

### 4. Documentation Updates

#### Update Output Documentation
**File**: `langpa/docs/output-management.md`

Add section:
```markdown
### Compact Bibliography

The container JSON includes a human-readable `compact_bibliography` field with rendered citation strings:

{
  "compact_bibliography": {
    "entries": [
      "[1] Doe et al. Example Paper 2024 10.1234/example",
      "[2] Smith Nature Study 2023 37674083"
    ],
    "style": "vancouver",
    "locale": "en-US",
    "renderer": "citeproc-py"
  }
}

The compact bibliography is generated using url2ref's rendering pipeline:
- **Primary renderer**: citeproc-py (professional citation formatting)
- **Fallback renderer**: Minimal compact format (zero dependencies)
- **Format**: `[id] author [et al.] title year identifier`
- **Identifier priority**: DOI > PMID > PMCID > URL

Configuration:
- `--citation-style`: Citation style (default: vancouver)
- `--citation-locale`: Locale for formatting (default: en-US)
```

#### Update README
**File**: `langpa/README.md`

Add to CLI examples:
```bash
# Generate bibliography with compact references
python scripts/run_deepsearch.py \
  --genes BRCA1 BRCA2 \
  --resolve-citations \
  --citation-style apa \
  --citation-locale en-GB
```

### 5. Optional Enhancements

#### A. Support Multiple Citation Styles
Allow generating multiple compact formats in one run:
```python
"compact_bibliography": {
  "vancouver": ["[1] Doe et al. ...", ...],
  "apa": ["Doe, J., et al. (2024). ...", ...],
  "chicago": [...],
  "renderer": "citeproc-py"
}
```

#### B. Add Standalone Compact File
Save compact bibliography to a separate text file:
```
deepsearch_bibliography.txt
-------------------------
[1] Doe et al. Example Paper 2024 10.1234/example
[2] Smith Nature Study 2023 37674083
[3] Johnson Research Work 2022 PMC11239014
```

#### C. Include in Markdown Output
Append compact bibliography to the DeepSearch markdown:
```markdown
## Research Summary
...

## References
[1] Doe et al. Example Paper 2024 10.1234/example
[2] Smith Nature Study 2023 37674083
```

### 6. Implementation Checklist

- [ ] Import `render_bibliography_to_strings` in `citation_resolver.py`
- [ ] Add `resolve_citations_with_compact()` method to `CitationResolver`
- [ ] Update `OutputManager.process_and_save_structured_output()` to include compact refs
- [ ] Add `--citation-style` and `--citation-locale` CLI options
- [ ] Write unit tests for compact bibliography generation
- [ ] Write integration test for full pipeline
- [ ] Update `output-management.md` documentation
- [ ] Update `README.md` with CLI examples
- [ ] Add type hints and docstrings
- [ ] Test with real PMID/DOI/URL examples
- [ ] Verify backward compatibility (containers without compact refs still work)
- [ ] Consider optional enhancements (multiple styles, standalone file, markdown append)

### 7. Backward Compatibility

The changes are fully backward compatible:
- Existing containers without `compact_bibliography` field remain valid
- Citation resolution can be disabled (no compact refs generated)
- Default behavior unchanged unless `--resolve-citations` is used
- CSL-JSON citations structure unchanged

### 8. Error Handling

If compact bibliography generation fails:
- Catch exceptions from `render_bibliography_to_strings()`
- Log error but continue pipeline
- Set `compact_bibliography.error` field with error message
- Include `compact_bibliography.renderer = "failed"` for diagnostics

### 9. Example Output

**Full container JSON with compact refs:**
```json
{
  "metadata": {
    "timestamp": "2024-12-10T10:30:00Z",
    "genes": ["BRCA1", "BRCA2"],
    "context": "breast cancer research",
    "provider": "perplexity",
    "model": "sonar-pro"
  },
  "deepsearch_raw": {
    "markdown": "...",
    "citations": [
      {"source_id": "1", "source_url": "https://pubmed.ncbi.nlm.nih.gov/37674083/"}
    ],
    "duration_seconds": 12.5
  },
  "report": {
    "summary": "...",
    "gene_reports": [...],
    "citations": [{"source_id": "1"}]
  },
  "citations": {
    "1": {
      "id": "1",
      "title": "BRCA1 and BRCA2 mutations in breast cancer",
      "author": [{"family": "Doe", "given": "John"}],
      "issued": {"date-parts": [[2024]]},
      "DOI": "10.1234/example",
      "PMID": "37674083",
      "URL": "https://pubmed.ncbi.nlm.nih.gov/37674083/",
      "resolution": {
        "confidence": 0.95,
        "methods": ["url_pattern", "api_lookup"],
        "validation": {"ncbi": "passed"}
      }
    }
  },
  "compact_bibliography": {
    "entries": [
      "[1] Doe BRCA1 and BRCA2 mutations in breast cancer 2024 10.1234/example"
    ],
    "style": "vancouver",
    "locale": "en-US",
    "renderer": "citeproc-py"
  },
  "bibliography_stats": {
    "total": 1,
    "resolved": 1,
    "unresolved": 0
  },
  "unresolved": []
}
```

## Summary

This plan extends langpa to include compact reference strings by:
1. Importing url2ref's `render_bibliography_to_strings()` function
2. Adding a new method to `CitationResolver` that generates both CSL-JSON and compact strings
3. Including compact bibliography in the container JSON output
4. Adding CLI options for citation style/locale
5. Maintaining full backward compatibility
6. Providing comprehensive test coverage

The implementation is straightforward, non-invasive, and leverages existing url2ref functionality with minimal additional code.
